<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>إعداد بيانات الأدمن</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body{font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:#f4f6fb;padding:30px}
        .card{max-width:720px;margin:0 auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
        .input-group{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
        input{flex:1;padding:10px;border:1px solid #ddd;border-radius:8px}
        button{padding:10px 14px;border-radius:8px;border:none;background:#0b5ed7;color:#fff;cursor:pointer}
        .note{color:#666;margin-top:10px}
        a{color:#0b5ed7;text-decoration:none}
    </style>
</head>
<body>
<div class="card">
    <h2>إنشاء أو تحديث بيانات الأدمن</h2>
    <p class="note">هذه الصفحة تسمح بإنشاء حساب الأدمن في البداية أو تغييره لاحقًا. تُخزن البيانات في قاعدة Firebase تحت المسار <strong>admin/credentials</strong>.</p>

    <div id="existsBox" style="display:none">
        <h3>تحديث بيانات الدخول</h3>
        <div class="input-group">
            <input type="text" id="currentUser" placeholder="اسم المستخدم الحالي">
            <input type="password" id="currentPass" placeholder="كلمة المرور الحالية">
        </div>
        <div class="input-group">
            <input type="text" id="newUser" placeholder="اسم المستخدم الجديد">
            <input type="password" id="newPass" placeholder="كلمة المرور الجديدة">
        </div>
        <div style="margin-top:12px">
            <button onclick="updateCredentials()">تحديث البيانات</button>
        </div>
    </div>

    <div id="createBox" style="display:none">
        <h3>إنشاء بيانات الدخول لأول مرة</h3>
        <div class="input-group">
            <input type="text" id="createUser" placeholder="اسم المستخدم الجديد">
            <input type="password" id="createPass" placeholder="كلمة المرور الجديدة">
        </div>
        <div style="margin-top:12px">
            <button onclick="createCredentials()">إنشاء</button>
        </div>
    </div>

    <p class="note" id="status"></p>
    <p style="margin-top:14px"><a href="admin.html">العودة إلى لوحة التحكم</a></p>
</div>

<script>
  const firebaseConfig = {
        apiKey: "AIzaSyDdLB3KHZVbNw3O9QrKJzBw2pL_pFn8Iso",
        databaseURL: "https://mazen-2ba04-default-rtdb.firebaseio.com",
        projectId: "mazen-2ba04"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const statusEl = document.getElementById('status');
    const existsBox = document.getElementById('existsBox');
    const createBox = document.getElementById('createBox');

    // تحقق من وجود بيانات بالفعل
    db.ref('admin/credentials').once('value').then(snap => {
        const v = snap.val();
        if(v && v.user) {
            existsBox.style.display = 'block';
            createBox.style.display = 'none';
            statusEl.innerText = 'تم اكتشاف بيانات أدمن حالية. استخدم النموذج أعلاه لتحديثها.';
        } else {
            existsBox.style.display = 'none';
            createBox.style.display = 'block';
            statusEl.innerText = 'لم يتم العثور على بيانات أدمن. أنشئ بيانات جديدة الآن.';
        }
    }).catch(err => { statusEl.innerText = 'خطأ في الاتصال بقاعدة البيانات: ' + err.message; createBox.style.display='block'; });

    async function hashString(str) {
        const enc = new TextEncoder();
        const data = enc.encode(str);
        const hashBuf = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuf));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function createCredentials(){
        const user = document.getElementById('createUser').value.trim();
        const pass = document.getElementById('createPass').value;
        if(!user || !pass) { alert('يرجى تعبئة اسم المستخدم وكلمة المرور'); return; }
        const hashed = await hashString(pass);
        db.ref('admin/credentials').set({ user, pass: hashed })
        .then(()=>{ alert('تم إنشاء بيانات الأدمن'); window.location.href = 'admin.html'; })
        .catch(err=> alert('خطأ في الحفظ: ' + err.message));
    }

    async function updateCredentials(){
        const curU = document.getElementById('currentUser').value.trim();
        const curP = document.getElementById('currentPass').value;
        const newU = document.getElementById('newUser').value.trim();
        const newP = document.getElementById('newPass').value;
        if(!curU || !curP) { alert('ادخل بيانات الدخول الحالية'); return; }
        const curHashed = await hashString(curP);
        db.ref('admin/credentials').once('value').then(async snap => {
            const v = snap.val();
            if(!v || v.user !== curU) { alert('البيانات الحالية غير صحيحة'); return; }
            // Accept legacy plaintext or hashed comparison
            const match = (v.pass === curHashed) || (v.pass === curP);
            if(!match) { alert('البيانات الحالية غير صحيحة'); return; }
            const finalUser = newU || curU;
            const finalPass = newP ? await hashString(newP) : v.pass;
            db.ref('admin/credentials').set({ user: finalUser, pass: finalPass })
            .then(()=>{ alert('تم تحديث بيانات الأدمن'); window.location.href = 'admin.html'; })
            .catch(err=> alert('خطأ في الحفظ: ' + err.message));
        }).catch(err=> alert('خطأ في التحقق: ' + err.message));
    }
</script>
</body>
</html>